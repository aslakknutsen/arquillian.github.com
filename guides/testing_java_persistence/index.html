<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Testing Java Persistence &#183; Arquillian Guides</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Test your data! Learn how to test Java Persistence (JPA) queries against multiple providers in an Arquillian test." name="description" />
    <link href="/blog/atom.xml" rel="alternate" title="Arquillian blog Atom feed" type="application/atom+xml" />
    <link href="/stylesheets/screen.css" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.js"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="shortcut icon" />
  </head>
  <body class="guide">
    <header class="navbar navbar-fixed-top" id="banner" role="banner">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">
            <span class="logo"></span>
            <span class="name">Arquillian</span>
          </a>
          <nav class="nav-collapse" role="navigation">
            <ul class="nav">
              <li><a href="/invasion/">Invasion!</a></li>
              <li><a href="/features/">Features</a></li>
              <li class="active"><a href="/guides/">Guides</a></li>
              <li><a href="/blog/">Blog</a></li>
              <li><a href="/community/">Community</a></li>
              <li><a href="/code/">Code</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <div id="main" role="main">
  <div id="content-header">
    <div class="container">
      <div class="headline">
        <h1>
          <a href="/guides/">Arquillian Guides</a>
          <small>Designed exclusively to teach you how to use Arquillian to write real tests.</small>
        </h1>
        <div class="directory">
          <a class="guides_menu" href="./" id="guides_menu">
            Guides Index
            <i class="icon-menu-closed"></i>
          </a>
          <div id="guides" style="display: none">
            <a class="guides_menu" href="./">
              Guides Index
              <i class="icon-menu-open"></i>
            </a>
            <hr class="clear" />
            <dl class="beg">
              <dt>First Steps</dt>
              <dd><a href="/guides/getting_started/">Getting Started</a>
              <br />
              <a href="/guides/getting_started/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
              <a href="/guides/getting_started_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
              <a href="/guides/getting_started_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
              <a href="/guides/getting_started_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
              <a href="/guides/getting_started_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
              <a href="/guides/getting_started_nl/"><img class="flag" rel="tooltip" src="/images/flags/nl.png" title="Nederlands (nl)" /></a>
              <a href="/guides/getting_started_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
              <a href="/guides/getting_started_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
              <a href="/guides/getting_started_sv_se/"><img class="flag" rel="tooltip" src="/images/flags/sv_se.png" title="Svenska (sv_se)" /></a>
              <a href="/guides/getting_started_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
              <dd><a href="/guides/getting_started_rinse_and_repeat/">Getting Started: Rinse and Repeat</a>
              <br />
              <a href="/guides/getting_started_rinse_and_repeat/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
              <a href="/guides/getting_started_rinse_and_repeat_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
              <a href="/guides/getting_started_rinse_and_repeat_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
              <a href="/guides/getting_started_rinse_and_repeat_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
              <a href="/guides/getting_started_rinse_and_repeat_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
              <a href="/guides/getting_started_rinse_and_repeat_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
              <dd><a href="/guides/get_started_faster_with_forge/">Get Started Faster with Forge</a>
              <br />
              <a href="/guides/get_started_faster_with_forge/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
              <a href="/guides/get_started_faster_with_forge_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
              <a href="/guides/get_started_faster_with_forge_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
              <a href="/guides/get_started_faster_with_forge_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
              <dd><a href="/guides/shrinkwrap_introduction/">Creating Deployable Archives with ShrinkWrap</a></dd>
            </dl>
            <dl class="int">
              <dt>More Coverage</dt>
              <dd><a href="/guides/testing_java_persistence/">Testing Java Persistence</a>
              <br />
              <a href="/guides/testing_java_persistence/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
              <a href="/guides/testing_java_persistence_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a></dd>
              <dd><a href="/guides/functional_testing_using_drone/">Functional Testing using Drone</a></dd>
            </dl>
            <dl class="adv">
              <dt>Enhance</dt>
              <dd><a href="/guides/testing_in_the_cloud/">Testing in the Cloud</a></dd>
            </dl>
            <dl class="ref">
              <dt>Reference</dt>
              <dd><a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Reference Guide</a></dd>
              <dd><a href="http://docs.jboss.org/arquillian/api/latest">API Docs</a>,
              <a href="http://docs.jboss.org/arquillian/spi/latest">SPI Docs</a></dd>
              <dd><a href="http://community.jboss.org/wiki/ArquillianMigrationGuides">Migration Guides</a></dd>
              <dd><a href="http://community.jboss.org/en/arquillian/faq">FAQs</a></dd>
            </dl>
          </div>
        </div>
        <script>$(function() { activateGuideMenuControl() })</script>
      </div>
    </div>
  </div>
  <div class="container" id="guide">
    <div id="content">
            <div class="header">
              <div class="header">
              <h2>Testing Java Persistence</h2>
              <div class="authors"><strong>Authors:</strong>
   <a href="https://community.jboss.org/people/dan.j.allen">Dan Allen</a>, <a href="https://community.jboss.org/people/bmajsak">Bartosz Majsak</a>, <a href="https://community.jboss.org/people/sewatech">Alexis Hassler</a>
  <strong style="padding-left: 10px;">Translations:</strong>
  <a href="/guides/testing_java_persistence_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
  <br />
  <strong>Level:</strong>
   More Coverage
  <strong style="padding-left: 10px;">Tags:</strong>
   jpa, database, persistence, transactions
  <strong style="padding-left: 10px;">Last Update:</strong> May 08, 2012</div>
              <p>This guide teaches you how to use Arquillian to test your Java Persistence (JPA) data layer. After reading this guide, you&#8217;ll be able to:</p>
              <ul>
	<li>Create a test archive that includes the JPA descriptor (persistence.xml)</li>
	<li>Inject the EntityManager and UserTransaction into your test</li>
	<li>Persist entities and retrieve them by querying via JPQL and the JPA 2 Criteria API</li>
	<li>Execute the tests using different JPA providers</li>
</ul>
              <p>You&#8217;ll soon discover that Arquillian offers the perfect recipe for testing JPA or to simply experiment with how it works. We&#8217;ve designed this guide to be easy to follow so that you can come back to it whenever you need to hammer on JPA.</p>
              </div>
              </div>
            <h3 id="assumptions">Assumptions</h3>
<p>We&#8217;ll assume that you&#8217;ve read either the <a href="/guides/getting_started">Getting Started</a> guide or the <a href="/guides/get_started_faster_with_forge">Get Started Faster with Forge</a> guide and already have an Arquillian test suite setup in a Maven project. Feel free to remove the Java classes to make way for the new lesson. We&#8217;ll be adding a JPA entity to the project to create a basic Java persistence test (JPA). From there, you can apply these instructions to other entities you may need to test.</p>
<p>The instructions in this guide are specific to a Maven project, though remember that Arquillian is not tied to Maven in any way. We&#8217;ll be running the tests in Embedded GlassFish and a local JBoss AS 7 instance. You can also use any other container that provides JPA and is supported by Arquillian.</p>
<p class="warning"><span>You can&#8217;t use the arquillian-weld-ee-embedded profile in this tutorial since Weld does not provide the JPA service (Weld only provides CDI).</span></p>
<h3 id="purpose">Purpose</h3>
<p>The application has a (video) <code>Game</code> entity containing two fields:</p>
<ul>
	<li><code>id</code> &#8211; the primary key</li>
	<li><code>title</code> &#8211; the title of the game</li>
</ul>
<p>We&#8217;ll be writing a test that persists sample entries to the database and then retrieve them using both JPQL and the JPA 2 Criteria API. When we&#8217;re done, the test will perform these three tasks:</p>
<ul>
	<li>store sample entities in the database using the JPA <code>EntityManager</code></li>
	<li>query the database using JPQL</li>
	<li>query the database using JPA 2 Criteria API</li>
</ul>
<p>The entire source code is available in the <a href="http://github.com/arquillian/arquillian-examples/tree/master/arquillian-persistence-tutorial">Arquillian examples project</a> on github. To see it in action, all you need to do is run the following command (and a hint of patience to wait for Maven to download the dependencies).</p>
<pre class="command"><code class="command">mvn test</code></pre>
<p>Let&#8217;s dig into how it works.</p>
<h3 id="project_structure">Project Structure</h3>
<p>To get you acclimated, here&#8217;s the directory structure of the project:</p>
<ul class="filetree">
	<li>src/
	<ul>
		<li>main/
		<ul>
			<li>java/
			<ul>
				<li>org/
				<ul>
					<li>arquillian/
					<ul>
						<li>example/
						<ul>
							<li>Game.java</li>
						</ul></li>
					</ul></li>
				</ul></li>
			</ul></li>
			<li>resources/
			<ul>
				<li>META-INF/
				<ul>
					<li>persistence.xml</li>
				</ul></li>
			</ul></li>
		</ul></li>
		<li>test/
		<ul>
			<li>java/
			<ul>
				<li>org/
				<ul>
					<li>arquillian/
					<ul>
						<li>example/
						<ul>
							<li>GamePersistenceTest.java</li>
						</ul></li>
					</ul></li>
				</ul></li>
			</ul></li>
			<li>resources/
			<ul>
				<li>arquillian.xml</li>
			</ul></li>
			<li>resources-glassfish-embedded/
			<ul>
				<li>glassfish-resources.xml</li>
				<li>logging.properties</li>
				<li>test-persistence.xml</li>
			</ul></li>
			<li>resources-jbossas-managed/
			<ul>
				<li>test-persistence.xml</li>
			</ul></li>
		</ul></li>
	</ul></li>
	<li>pom.xml</li>
</ul>
<p><code>Game</code> is the JPA entity class and test-persistence.xml is a modified version of persistence.xml that provides the definition of our Persistence Unit for the test environment. Notice there are two test folders containing a test-persistence.xml file, one for each container we&#8217;ll be using. We&#8217;ll explain how those get selected later.</p>
<p>We recommend using a dedicated JPA descriptor as a best practice for testing to accomodate using a different DataSource for testing and configuring your persistence provider differently from production. For example, in the test environment, you may want to use a &#8220;drop-and-create-tables&#8221; strategy to manage the schema of the DataSource. You may also want see the database queries in the logging output. These settings can be activated in test-persistence.xml without affecting the main application, as you&#8217;ll see below. We&#8217;ll leave the main persistence.xml alone since that&#8217;s the definition for the production environment.</p>
<p>Here&#8217;s the source of the <code>Game</code> entity class, as denoted by the <code>@Entity</code> annotation:</p>
<div class="filename">src/main/resources/org/arquillian/example/Game.java</div>
<pre class="prettify"><code class="prettify">package org.arquillian.example;</code>&#x000A; &#x000A;<code class="prettify">import java.io.Serializable;&#x000A;import javax.persistence.Entity;&#x000A;import javax.persistence.GeneratedValue;&#x000A;import javax.persistence.Id;&#x000A;import javax.validation.constraints.NotNull;&#x000A;import javax.validation.constraints.Size;</code>&#x000A; &#x000A;<code class="prettify">@Entity&#x000A;public class Game implements Serializable {&#x000A;    private Long id;&#x000A;    private String title;</code>&#x000A; &#x000A;<code class="prettify">    public Game() {}</code>&#x000A; &#x000A;<code class="prettify">    public Game(String title) {&#x000A;        this.title = title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @Id @GeneratedValue&#x000A;    public Long getId() {&#x000A;        return id;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    public void setId(Long id) {&#x000A;        this.id = id;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @NotNull&#x000A;    @Size(min = 3, max = 50)&#x000A;    public String getTitle() {&#x000A;        return title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    public void setTitle(String title) {&#x000A;        this.title = title;&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    @Override&#x000A;    public String toString() {&#x000A;        return "Game@" + hashCode() + "[id = " + id + "; title = " + title + "]";&#x000A;    }&#x000A;}</code></pre>
<p>The primary key is defined using the <code>@Id</code> annotation on the field. Additional columns are derived automatically from bean properties (standard getter/setter convention). You can use the <code>@Column</code> annotation to explicitly set the name of the column. Otherwise, the column name is determined by removing the &#8220;get&#8221; prefix from the bean property&#8217;s read method and lowercasing the first character of the remainder (e.g., getTitle() &rarr; title).</p>
<p>We&#8217;re also using standard Bean Validation annotations to enforce constraints. Here, a title must be provided and it must be between 3 and 50 characters long. (Hint: That would make another good test).</p>
<h3 id="write_the_test">Write the Test</h3>
<p>Speaking of tests, let&#8217;s create a new JUnit 4 Arquillian test case, <code>GamePersistenceTest</code>, and prepare it to test our JPA operations. We&#8217;ll leverage <a href="http://docs.jboss.org/cdi/spec/1.0/html" title="JSR-299">CDI</a> to supply us with the resources we need via dependency injection. (Alternatively, you could use a utility EJB to handle the transaction boundaries, which we&#8217;ll visit in a later guide).</p>
<div class="filename">src/test/java/org/arquillian/example/GamePersistenceTest.java</div>
<pre class="prettify"><code class="prettify">package org.arquillian.example;</code>&#x000A;&#x000A;<code class="prettify">import java.util.List;&#x000A;import javax.inject.Inject;&#x000A;import javax.persistence.EntityManager;&#x000A;import javax.persistence.PersistenceContext;&#x000A;import javax.transaction.UserTransaction;&#x000A;import org.jboss.arquillian.container.test.api.Deployment;&#x000A;import org.jboss.arquillian.junit.Arquillian;&#x000A;import org.jboss.shrinkwrap.api.Archive;&#x000A;import org.jboss.shrinkwrap.api.ShrinkWrap;&#x000A;import org.jboss.shrinkwrap.api.asset.EmptyAsset;&#x000A;import org.jboss.shrinkwrap.api.spec.WebArchive;&#x000A;import org.junit.runner.RunWith;</code>&#x000A;&#x000A;<code class="prettify">@RunWith(Arquillian.class)&#x000A;public class GamePersistenceTest {&#x000A;    @Deployment&#x000A;    public static Archive&lt;?&gt; createDeployment() {&#x000A;        return ShrinkWrap.create(WebArchive.class, "test.war")&#x000A;            .addPackage(Game.class.getPackage())&#x000A;            .addAsResource("test-persistence.xml", "META-INF/persistence.xml")&#x000A;            .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");&#x000A;    }</code>&#x000A; &#x000A;<code class="prettify">    private static final String[] GAME_TITLES = {&#x000A;        "Super Mario Brothers",&#x000A;        "Mario Kart",&#x000A;        "F-Zero"&#x000A;    };</code>&#x000A;    &#x000A;<code class="prettify">    @PersistenceContext&#x000A;    EntityManager em;</code>&#x000A;    &#x000A;<code class="prettify">    @Inject&#x000A;    UserTransaction utx;</code>&#x000A; &#x000A;<code class="prettify">    // tests go here&#x000A;}</code></pre>
<p>Let&#8217;s work from top to bottom to understand what&#8217;s going on here before we get to the tests.</p>
<dl>
	<dt>@RunWith(Arquillian.class)</dt>
	<dd>Tells JUnit to delegate execution of the test to the Arquillian runner. This allows Arquillian to provide a component model for your test, which consists of container lifecycle management and dependency injection, among other enhancements. Notice that you are not required to extend a base class, leaving that door open for other purposes.</dd>
	<dt>@Deployment method</dt>
	<dd>Builds and returns a &#8220;micro deployment&#8221; archive using <a href="http://jboss.org/shrinkwrap">ShrinkWrap</a>.  Arquillian deploys this archive, which also bundles the test case and some additional infrastructure, to the container. The test then executes as a component within this micro application. The contents of this archive make up an isolated world for the test.</dd>
	<dt>GAME_TITLES constant</dt>
	<dd>The sample test data</dd>
	<dt>@PersistenceContext EntityManager</dt>
	<dd>Injects the persistence context (i.e., <code>EntityManager</code>) directly into the test, just as though the test were a <a href="http://download.oracle.com/javaee/6/api/javax/annotation/ManagedBean.html">managed bean</a>.</dd>
	<dt>@Inject UserTransaction</dt>
	<dd>Injects a JTA transaction directly into the test, a service provided to the managed bean by CDI (JSR-299).</dd>
</dl>
<p>To avoid cluttering the test&#8217;s logic with persistence-related setup, let&#8217;s introduce intercepting methods which will be triggered before and after each test&#8217;s execution. Let&#8217;s have a look at this cross-cutting code.</p>
<p>The <code>@Before</code> method, invoked before each test, performs the following tasks:</p>
<ol>
	<li>Clean database state to avoid remaining data from a previous test execution</li>
	<li>Insert sample data needed for the test</li>
	<li>Begin a transaction</li>
</ol>
<p>Here are the methods you&#8217;ll add to your test case, along with one import statement:</p>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import org.junit.Before;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Before&#x000A;public void preparePersistenceTest() throws Exception {&#x000A;    clearData();&#x000A;    insertData();&#x000A;    startTransaction();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void clearData() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;    System.out.println("Dumping old records...");&#x000A;    em.createQuery("delete from Game").executeUpdate();&#x000A;    utx.commit();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void insertData() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;    System.out.println("Inserting records...");&#x000A;    for (String title : GAME_TITLES) {&#x000A;        Game game = new Game(title);&#x000A;        em.persist(game);&#x000A;    }&#x000A;    utx.commit();&#x000A;    // clear the persistence context (first-level cache)&#x000A;    em.clear();&#x000A;}</code>&#x000A;&#x000A;<code class="prettify">private void startTransaction() throws Exception {&#x000A;    utx.begin();&#x000A;    em.joinTransaction();&#x000A;}</code></pre>
<p>We also need a method to commit the transaction after each test, which requires an additional import as well:</p>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import org.junit.After;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@After&#x000A;public void commitTransaction() throws Exception {&#x000A;    utx.commit();&#x000A;}</code></pre>
<p>Arquillian executes the <code>@Before</code> and <code>@After</code> methods inside the container, before and after each test method, respectively. The <code>@Before</code> method gets invoked after the injections have occurred.</p>
<p>Notice we have to explicitly enlist the <code>EntityManager</code> in the JTA transaction. This step is necessary since we are using the two resources independently. This may look abnormal if you&#8217;re used to using JPA from within an EJB, where enlistment happens automatically.</p>
<h4>Query with JPQL</h4>
<p>Here&#8217;s the test that verifies we can select the sample records using JPQL. We&#8217;ll print some logging statements so you can watch what&#8217;s going on.</p>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import java.util.List;&#x000A;import org.junit.Test;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Test&#x000A;public void shouldFindAllGamesUsingJpqlQuery() throws Exception {&#x000A;    // given&#x000A;    String fetchingAllGamesInJpql = "select g from Game g order by g.id";</code>&#x000A;&#x000A;<code class="prettify">    // when&#x000A;    System.out.println("Selecting (using JPQL)...");&#x000A;    List&lt;Game&gt; games = em.createQuery(fetchingAllGamesInJpql, Game.class).getResultList();</code>&#x000A;&#x000A;<code class="prettify">    // then&#x000A;    System.out.println("Found " + games.size() + " games (using JPQL):");&#x000A;    assertContainsAllGames(games);&#x000A;}</code></pre>
<p>We finish the test with a call to <code>assertContainsAllGames</code>. This is a custom assertion method that verifies that the returned collection contains all the titles stored in the database.</p>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import java.util.Arrays;&#x000A;import java.util.Collection;&#x000A;import java.util.HashSet;&#x000A;import java.util.Set;&#x000A;import org.junit.Assert;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">private static void assertContainsAllGames(Collection&lt;Game&gt; retrievedGames) {&#x000A;    Assert.assertEquals(GAME_TITLES.length, retrievedGames.size());&#x000A;    final Set&lt;String&gt; retrievedGameTitles = new HashSet&lt;String&gt;();&#x000A;    for (Game game : retrievedGames) {&#x000A;        System.out.println("* " + game);&#x000A;        retrievedGameTitles.add(game.getTitle());&#x000A;    }&#x000A;    Assert.assertTrue(retrievedGameTitles.containsAll(Arrays.asList(GAME_TITLES)));&#x000A;}</code></pre>
<p>Using a separate method for assertions provides two benefits:</p>
<ul>
	<li>It clearly explains what we are expecting</li>
	<li>It can be reused in other tests</li>
</ul>
<p>Now onto a new feature in JPA 2, the Criteria API!</p>
<h4>Generating the JPA 2 Metamodel</h4>
<p>When using the Criteria API, ideally you want to reference the JPA 2 Metamodel classes to keep everything &#8220;type-safe&#8221;. To generate these classes in Maven, we first have to tell Maven it&#8217;s okay to use JDK 6 (it&#8217;s stubborn like that).</p>
<div class="filename">pom.xml</div>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;build&gt;&#x000A;    &lt;plugins&gt;&#x000A;        &lt;plugin&gt;&#x000A;            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;&#x000A;            &lt;version&gt;2.3.2&lt;/version&gt;&#x000A;            &lt;configuration&gt;&#x000A;                &lt;source&gt;1.6&lt;/source&gt;&#x000A;                &lt;target&gt;1.6&lt;/target&gt;&#x000A;            &lt;/configuration&gt;&#x000A;        &lt;/plugin&gt;&#x000A;    &lt;/plugins&gt;&#x000A;&lt;/build&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
<p>We also need to configure Maven to run the JPA 2 annotation processor, which is done simply by adding the Hibernate JPA metamodel generator as a compile-only project dependency:</p>
<div class="filename">pom.xml</div>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;dependency&gt;&#x000A;    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;&#x000A;    &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;&#x000A;    &lt;version&gt;1.2.0.Final&lt;/version&gt;&#x000A;    &lt;scope&gt;provided&lt;/scope&gt;&#x000A;&lt;/dependency&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
<p class="info"><span>The metamodel generator will run automatically if you are using a JDK 6 compiler and the annotation processor jar is on the classpath.</span></p>
<p>Getting the JPA 2 Metamodel to generate in Eclipse is a little more tricky. Begin by creating the a file name .factorypath at the root of the project and populating it with the following configuration:</p>
<div class="filename">.factorypath</div>
<pre class="prettify"><code class="prettify">&lt;factorypath&gt;&#x000A;    &lt;factorypathentry kind="VARJAR" enabled="true" runInBatchMode="false"&#x000A;        id="M2_REPO/org/hibernate/hibernate-jpamodelgen/1.2.0.Final/hibernate-jpamodelgen-1.2.0.Final.jar"/&gt;&#x000A;    &lt;factorypathentry kind="VARJAR" enabled="true" runInBatchMode="false"&#x000A;        id="M2_REPO/org/hibernate/javax/persistence/hibernate-jpa-2.0-api/1.0.0.Final/hibernate-jpa-2.0-api-1.0.0.Final.jar"/&gt;&#x000A;&lt;/factorypath&gt;</code></pre>
<p>Next, right click on the project and select Properties. Expand the Java Compiler node in the settings tree and select Annotation Processing. Change the following values:</p>
<ul>
	<li>Check the box &quot;Enable project specific settings</li>
	<li>Check the box &#8220;Enable annotation processing&#8221;</li>
	<li>Set the &#8220;Generated source directory&#8221; to &#8220;target/generated-sources/annotations&#8221; (without quotes)</li>
	<li>Click the Apply button and accept a full build</li>
	<li>Uncheck the box &#8220;Enable annotation processing&#8221;</li>
	<li>Click the Apply button and skip a full build</li>
	<li>Check the box &#8220;Enable annotation processing&#8221;</li>
	<li>Click the Apply button and accept a full build</li>
</ul>
<p>You should now see <code>Game_.java</code> under the target/generated-sources/annotations directory, which should also be on the build path.</p>
<p class="info"><span>Yes, you have to fiddle with it a little bit, just like you have to kick the snack machine for your snack to drop <img src="/images/emoticons/smile.png" alt=":)" class="emoticon" /> If it&#8217;s too much trouble, you can skip the metamodel generation and simply reference column names using string values.</span></p>
<p>At last, you are ready to write a criteria query!</p>
<h4>Query with the Critiera API</h4>
<p>Here&#8217;s a copy of the previous test that has been updated to use the Criteria API. Notice that this test depends on the JPA 2 annotation processor generating the <code>Game_</code> metamodel class during the build compilation step.</p>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;import javax.persistence.criteria.CriteriaBuilder;&#x000A;import javax.persistence.criteria.CriteriaQuery;&#x000A;import javax.persistence.criteria.Root;&#x000A;&lt;!-- clip --&gt;</code>&#x000A;&#x000A;<code class="prettify">@Test&#x000A;public void shouldFindAllGamesUsingCriteriaApi() throws Exception {&#x000A;    // given&#x000A;    CriteriaBuilder builder = em.getCriteriaBuilder();&#x000A;    CriteriaQuery&lt;Game&gt; criteria = builder.createQuery(Game.class);</code>&#x000A;    		&#x000A;<code class="prettify">    Root&lt;Game&gt; game = criteria.from(Game.class);&#x000A;    criteria.select(game);&#x000A;    // TIP: If you don't want to use the JPA 2 Metamodel,&#x000A;    // you can change the get() method call to get("id")&#x000A;    criteria.orderBy(builder.asc(game.get(Game_.id)));&#x000A;    // No WHERE clause, which implies select all</code>&#x000A;&#x000A;<code class="prettify">    // when&#x000A;    System.out.println("Selecting (using Criteria)...");&#x000A;    List&lt;Game&gt; games = em.createQuery(criteria).getResultList();</code>&#x000A;&#x000A;<code class="prettify">    // then&#x000A;    System.out.println("Found " + games.size() + " games (using Criteria):");&#x000A;    assertContainsAllGames(games);&#x000A;}</code></pre>
<p>In order for JPA to work, it also needs a Persistence Unit.</p>
<p>We define the Persistence Unit in a test-persistence.xml file that&#8217;s corresponding to the target container. ShrinkWrap takes this file from the classpath and puts it into its standard location within the archive.</p>
<pre class="prettify"><code class="prettify">.addAsResource("test-persistence.xml", "META-INF/persistence.xml")</code></pre>
<p>Here&#8217;s the structure of the archive that ShrinkWrap will assemble for this test case (minus the Arquillian infrastructure):</p>
<ul class="filetree">
	<li>WEB-INF/
	<ul>
		<li>beans.xml</li>
		<li>classes/
		<ul>
			<li>META-INF/
			<ul>
				<li>persistence.xml</li>
			</ul></li>
			<li>org/
			<ul>
				<li>arquillian/
				<ul>
					<li>example/
					<ul>
						<li>Game.class</li>
						<li>GamePersistenceTestCase.class</li>
						<li>Game_.class</li>
					</ul></li>
				</ul></li>
			</ul></li>
		</ul></li>
		<li>lib/
		<ul>
			<li>*.jar</li>
		</ul></li>
	</ul></li>
</ul>
<p>Let&#8217;s look at the Persistence Unit descriptor we&#8217;ll be using in the test, starting with the one for Embedded GlassFish.</p>
<h3 id="setup_persistence_for_glassfish">Setup Persistence for GlassFish</h3>
<p>Here&#8217;s the Persistence Unit descriptor we&#8217;ll be using for Embedded GlassFish:</p>
<div class="filename">src/test/resources-glassfish-embedded/test-persistence.xml</div>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="eclipselink.ddl-generation" value="drop-and-create-tables"/&gt;&#x000A;            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;&#x000A;            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
<p>We set two vendor-specific properties to activate features of the built-in provider, EclipseLink:</p>
<dl>
	<dt>eclipselink.ddl-generation</dt>
	<dd>Configures the database schema command. The value drop-and-create-tables tells EclipseLink to generate the database as declared by the JPA entities on each run.</dd>
	<dt>eclipselink.logging.level.sql</dt>
	<dd>Configures query logging. The value FINE enables logging of SQL statements, allowing us to monitor the database activity.</dd>
</dl>
<p>EclipseLink logging needs to be further configured by enabling the FINE level in the Java logging configuration file.</p>
<div class="filename">src/test/resources-glassfish-embedded/logging.properties</div>
<pre class="prettify"><code class="prettify">handlers=java.util.logging.ConsoleHandler&#x000A;java.util.logging.ConsoleHandler.formatter=java.util.logging.SimpleFormatter&#x000A;java.util.logging.SimpleFormatter.format=%4$s: %5$s%n&#x000A;java.util.logging.ConsoleHandler.level=FINEST</code></pre>
<p>The Persistence Unit is test-persistence.xml refers to a DataSource named jdbc/arquillian. Where&#8217;s that defined? Ah, that&#8217;s something the Arquillian container adapter needs to setup.</p>
<p>We want to use the GlassFish APIs to create a JDBC Connection Pool and associated Resource. But we don&#8217;t want to have to code it. We just want to declare it. That&#8217;s where Arquillian comes in.</p>
<p>First, we create a glassfish-resources.xml file containing the resource definitions, which GlassFish knows how to consume.</p>
<div class="filename">src/test/resources-glassfish-embedded/glassfish-resources.xml</div>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;!DOCTYPE resources PUBLIC&#x000A;    "-//GlassFish.org//DTD GlassFish Application Server 3.1 Resource Definitions//EN"&#x000A;    "http://glassfish.org/dtds/glassfish-resources_1_5.dtd"&gt;&#x000A;&lt;resources&gt;&#x000A;    &lt;jdbc-resource pool-name="ArquillianEmbeddedDerbyPool"&#x000A;        jndi-name="jdbc/arquillian"/&gt;&#x000A;    &lt;jdbc-connection-pool name="ArquillianEmbeddedDerbyPool"&#x000A;        res-type="javax.sql.DataSource"&#x000A;        datasource-classname="org.apache.derby.jdbc.EmbeddedDataSource"&#x000A;        is-isolation-level-guaranteed="false"&gt;&#x000A;        &lt;property name="databaseName" value="target/databases/derby"/&gt;&#x000A;        &lt;property name="createDatabase" value="create"/&gt;&#x000A;    &lt;/jdbc-connection-pool&gt;&#x000A;&lt;/resources&gt;</code></pre>
<p>We&#8217;ve now isolated the DataSource definition from the test in the same way we do in the main application. The further benefit is that we can define any resources we might need for our test. Imagine the possibilities.</p>
<p>Now we need to tell Arquillian to use this file. We open up the Arquillian configuration and configure the Embedded GlassFish container adapter to pick up this file, which it will then feed to the <code>add-resources</code> command of the GlassFish administration API.</p>
<div class="filename">src/test/resources/arquillian.xml</div>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;arquillian xmlns="http://jboss.org/schema/arquillian"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://jboss.org/schema/arquillian&#x000A;        http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;&#x000A;    &lt;container qualifier="glassfish-embedded" default="true"&gt;&#x000A;        &lt;configuration&gt;&#x000A;            &lt;property name="resourcesXml"&gt;&#x000A;                src/test/resources-glassfish-embedded/glassfish-resources.xml&#x000A;            &lt;/property&gt;&#x000A;        &lt;/configuration&gt;&#x000A;    &lt;/container&gt;&#x000A;&lt;/arquillian&gt;</code></pre>
<p>Alternatively, you can skip the DataSource configuration and simply include the database connection information directly in test-persistence.xml using standard database connection properties:</p>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="javax.persistence.jdbc.driver"&#x000A;                value="org.apache.derby.jdbc.EmbeddedDriver"/&gt;&#x000A;            &lt;property name="javax.persistence.jdbc.url"&#x000A;                value="jdbc:derby:target/databases/derby;create=true"/&gt;&#x000A;            &lt;property name="eclipselink.ddl-generation" value="drop-and-create-tables"/&gt;&#x000A;            &lt;property name="eclipselink.logging.level.sql" value="FINE"/&gt;&#x000A;            &lt;property name="eclipselink.logging.parameters" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
<p>Keep in mind, though, that the switch from a JNDI DataSource to an explicit database connection changes the architecture between the production and test environment, thus giving you less confidence that your test is catching all potential failures.</p>
<p>All that&#8217;s left now is to setup the container adapter and execute the test.</p>
<h3 id="prep_the_test_for_glassfish">Prep the Test for GlassFish</h3>
<p>We&#8217;re going to separate out the target containers using Maven profiles. All of the profiles will share a common set of dependencies (as setup in the <a href="/guides/getting_started/">Getting Started</a> guide):</p>
<div class="filename">pom.xml</div>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;dependencyManagement&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.arquillian&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;arquillian-bom&lt;/artifactId&gt;&#x000A;            &lt;version&gt;1.0.0.Final&lt;/version&gt;&#x000A;            &lt;scope&gt;import&lt;/scope&gt;&#x000A;            &lt;type&gt;pom&lt;/type&gt;&#x000A;        &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;&lt;/dependencyManagement&gt;&#x000A;&lt;dependencies&gt;&#x000A;    &lt;dependency&gt;&#x000A;        &lt;groupId&gt;junit&lt;/groupId&gt;&#x000A;        &lt;artifactId&gt;junit&lt;/artifactId&gt;&#x000A;        &lt;version&gt;4.8.1&lt;/version&gt;&#x000A;    &lt;/dependency&gt;&#x000A;    &lt;dependency&gt;&#x000A;        &lt;groupId&gt;org.jboss.arquillian.junit&lt;/groupId&gt;&#x000A;        &lt;artifactId&gt;arquillian-junit-container&lt;/artifactId&gt;&#x000A;        &lt;scope&gt;test&lt;/scope&gt;&#x000A;    &lt;/dependency&gt;&#x000A;&lt;/dependencies&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
<p class="warning"><span>If you plan to use a database that isn&#8217;t bundled with the application server, such as MySQL, you&#8217;ll need to include its client libraries on the classpath as well. See the <a href="http://github.com/arquillian/arquillian-examples/tree/master/arquillian-persistence-tutorial">sample project</a> for an example of using the H2 database instead of Derby.</span></p>
<p>Now add (or modify) the profile for Embedded GlassFish:</p>
<div class="filename">pom.xml</div>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;profile&gt;&#x000A;    &lt;id&gt;arquillian-glassfish-embedded&lt;/id&gt;&#x000A;    &lt;activation&gt;&#x000A;        &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;&#x000A;    &lt;/activation&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.arquillian.container&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;arquillian-glassfish-embedded-3.1&lt;/artifactId&gt;&#x000A;            &lt;version&gt;1.0.0.CR3&lt;/version&gt;&#x000A;        &lt;/dependency&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.glassfish.main.extras&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;glassfish-embedded-web&lt;/artifactId&gt;&#x000A;            &lt;version&gt;3.1.2&lt;/version&gt;&#x000A;        &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;    &lt;build&gt;&#x000A;        &lt;testResources&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources-glassfish-embedded&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;        &lt;/testResources&gt;&#x000A;        &lt;plugins&gt;&#x000A;            &lt;plugin&gt;&#x000A;                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;&#x000A;                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;&#x000A;                &lt;version&gt;2.12&lt;/version&gt;&#x000A;                &lt;configuration&gt;&#x000A;                    &lt;systemPropertyVariables&gt;&#x000A;                        &lt;java.util.logging.config.file&gt;&#x000A;                            ${project.build.testOutputDirectory}/logging.properties&#x000A;                        &lt;/java.util.logging.config.file&gt;&#x000A;                        &lt;derby.stream.error.file&gt;&#x000A;                            ${project.build.directory}/derby.log&#x000A;                        &lt;/derby.stream.error.file&gt;&#x000A;                    &lt;/systemPropertyVariables&gt;&#x000A;                &lt;/configuration&gt;&#x000A;            &lt;/plugin&gt;&#x000A;        &lt;/plugins&gt;&#x000A;    &lt;/build&gt;&#x000A;&lt;/profile&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
<p>We are explicitly adding the src/test/resources-glassfish-embedded directory as a test resource directory so that test-persistence.xml is placed into the classpath. We&#8217;ve also configured the surefire plugin to pass the Java Logging configuration file to the forked Java process to get the SQL logging to work. Finally, we push the Derby log file into the build output directory so that it gets swept away when we clean the project.</p>
<p class="info"><span>If you don&#8217;t plan to test using different containers, you don&#8217;t need to wrap the configuration above inside a profile.</span></p>
<h3 id="run_the_test_on_glassfish">Run the Test on GlassFish</h3>
<p>When you are done setting everything up, you can run the test in the IDE by selecting Run As &gt; JUnit Test or from Maven using the following command:</p>
<pre class="command"><code class="command">$ mvn clean test</code></pre>
<p>The Maven profile for Embedded GlassFish is activated by default (as is the container adapter configuration in arquillian.xml). Snippets of the test output is show below.</p>
<pre class="output"><code class="output">...&#x000A;Running org.arquillian.example.GamePersistenceTest&#x000A;...&#x000A;INFO: GlassFish Server Open Source Edition 3.1.2 (java_re-private) ...&#x000A;...&#x000A;INFO: command add-resources result: PlainTextActionReporterSUCCESSDescription: add-resources AdminCommandnull&#x000A;    JDBC connection pool ArquillianEmbeddedDerbyPool created successfully.&#x000A;    JDBC resource jdbc/arquillian created successfully.&#x000A;...&#x000A;INFO: WEB0671: Loading application [test] at [/test]&#x000A;...&#x000A;Dumping old records...&#x000A;FINE: DELETE FROM GAME&#x000A;Inserting records...&#x000A;FINE: UPDATE SEQUENCE SET SEQ_COUNT = SEQ_COUNT + ? WHERE SEQ_NAME = ?&#x000A;   bind =&gt; [50, SEQ_GEN]&#x000A;FINE: SELECT SEQ_COUNT FROM SEQUENCE WHERE SEQ_NAME = ?&#x000A;   bind =&gt; [SEQ_GEN]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [3, F-Zero]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [1, Super Mario Brothers]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [2, Mario Kart]&#x000A;Selecting (using JPQL)...&#x000A;FINE: SELECT ID, TITLE FROM GAME ORDER BY ID ASC&#x000A;Found 3 games (using JPQL):&#x000A;* Game@599290122[id = 1; title = Super Mario Brothers]&#x000A;* Game@1550721071[id = 2; title = Mario Kart]&#x000A;* Game@1107500305[id = 3; title = F-Zero]&#x000A;FINE: DELETE FROM GAME&#x000A;Inserting records...&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [5, Mario Kart]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [6, F-Zero]&#x000A;FINE: INSERT INTO GAME (ID, TITLE) VALUES (?, ?)&#x000A;   bind =&gt; [4, Super Mario Brothers]&#x000A;Selecting (using Criteria)...&#x000A;FINE: SELECT ID, TITLE FROM GAME ORDER BY ID ASC&#x000A;Found 3 games (using Criteria):&#x000A;* Game@1020493092[id = 4; title = Super Mario Brothers]&#x000A;* Game@1622992302[id = 5; title = Mario Kart]&#x000A;* Game@294335520[id = 6; title = F-Zero]&#x000A;...</code></pre>
<p><strong>Congratulations!</strong> <strong class="greenbar">Green bar</strong>! <em>Now that&#8217;s a real integration test!</em></p>
<p class="important"><span>As you introduce advanced JPA mappings, such as lazy loading and fetch groups, you may run into errors or warnings caused by Embedded GlassFish interfering with the necessary weaving step in EclipseLink. Additional build configuration is required to workaround this problem. Refer to <a href="http://blog.eisele.net/2012/01/arquillian-with-netbeans-glassfish_18.html">Markus Eisele&#8217;s blog</a> for instructions. You won&#8217;t have this problem when using a managed or remote container adapter.</span></p>
<h3 id="run_the_test_on_jboss_as_7">Run the Test on JBoss AS 7</h3>
<p>We can run the exact same test on JBoss AS 7 with a few classpath tweaks.</p>
<p>We&#8217;ll first need a different Persistence Unit definition that specifies a DataSource that&#8217;s available on JBoss AS (and optionally sets some Hibernate configuration settings).</p>
<p>If you were using JBoss AS 7.0, you&#8217;d need to <a href="https://docs.jboss.org/author/display/AS7/Admin+Guide#AdminGuide-Datasources">setup a DataSource manually in the JBoss AS configuration</a> or leverage the built-in DataSource, java:jboss/datasources/ExampleDS. Here&#8217;s the Persistence Unit descriptor for JBoss AS 7.0 that uses the built-in DataSource.</p>
<div class="filename">src/test/resources-jbossas-managed/test-persistence.xml</div>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;java:jboss/datasources/ExampleDS&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;&#x000A;            &lt;property name="hibernate.show_sql" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
<p>The Hibernate-specific properties hibernate.hbm2ddl.auto and hibernate.show_sql perform the same two functions as the EclipseLink properties previously described.</p>
<p>If you&#8217;re using JBoss AS 7.1, which we recommend, you can register a new DataSource dynamically by adding a DataSource descriptor (i.e., a file with the extension -ds.xml) containing one or more DataSource definitions to the META-INF directory of a java archive or the WEB-INF directory of a web archive.</p>
<p>Here&#8217;s a descriptor that defines an H2 DataSource with the JNDI name jdbc/arquillian (the same JNDI name as the DataSource we defined earlier for GlassFish):</p>
<div class="filename">src/test/resources/jbossas-ds.xml</div>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;datasources xmlns="http://www.jboss.org/ironjacamar/schema"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://www.jboss.org/ironjacamar/schema&#x000A;        http://docs.jboss.org/ironjacamar/schema/datasources_1_0.xsd"&gt;&#x000A;    &lt;datasource enabled="true"&#x000A;        jndi-name="jdbc/arquillian"&#x000A;        pool-name="ArquillianEmbeddedH2Pool"&gt;&#x000A;        &lt;connection-url&gt;jdbc:h2:mem:arquillian;DB_CLOSE_DELAY=-1&lt;/connection-url&gt;&#x000A;        &lt;driver&gt;h2&lt;/driver&gt;&#x000A;    &lt;/datasource&gt;&#x000A;&lt;/datasources&gt;</code></pre>
<p class="info"><span>JBoss AS 7.1 supports the H2 database out of the box. To use another database, you have to add the corresponding driver to the installation as described in <a href="https://docs.jboss.org/author/display/AS71/Admin+Guide#AdminGuide-Datasources">DataSources chapter of the JBoss AS 7.1 reference guide</a>.</span></p>
<p>We need to update our Persistence Unit to reference our new DataSource:</p>
<div class="filename">src/test/resources-jbossas-managed/test-persistence.xml</div>
<pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&#x000A;&lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"&#x000A;    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&#x000A;    xsi:schemaLocation="&#x000A;        http://java.sun.com/xml/ns/persistence&#x000A;        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;&#x000A;    &lt;persistence-unit name="test"&gt;&#x000A;        &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;&#x000A;        &lt;properties&gt;&#x000A;            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;&#x000A;            &lt;property name="hibernate.show_sql" value="true"/&gt;&#x000A;        &lt;/properties&gt;&#x000A;    &lt;/persistence-unit&gt;&#x000A;&lt;/persistence&gt;</code></pre>
<p>We also need to add the descriptor to the WEB-INF directory of the test archive. Add the following method to the ShrinkWrap builder in the <code>@Deployment</code> method of the test case:</p>
<pre class="prettify"><code class="prettify">.addAsWebInfResource("jbossas-ds.xml")</code></pre>
<p>Including this file in the archive does not impact the ability to run the test on Embedded GlassFish. The DataSource and the Persistence Unit are ready to go.</p>
<p>Next we&#8217;ll define a Maven profile that puts the JBoss AS container adapter and the JBoss AS resources folder on the classpath:</p>
<div class="filename">pom.xml</div>
<pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;&#x000A;&lt;profile&gt;&#x000A;    &lt;id&gt;arquillian-jbossas-managed&lt;/id&gt;&#x000A;    &lt;dependencies&gt;&#x000A;        &lt;dependency&gt;&#x000A;            &lt;groupId&gt;org.jboss.as&lt;/groupId&gt;&#x000A;            &lt;artifactId&gt;jboss-as-arquillian-container-managed&lt;/artifactId&gt;&#x000A;            &lt;version&gt;7.1.1.Final&lt;/version&gt;&#x000A;            &lt;scope&gt;test&lt;/scope&gt;&#x000A;        &lt;/dependency&gt;&#x000A;         &lt;dependency&gt;&#x000A;             &lt;groupId&gt;org.jboss.spec&lt;/groupId&gt;&#x000A;             &lt;artifactId&gt;jboss-javaee-web-6.0&lt;/artifactId&gt;&#x000A;             &lt;version&gt;3.0.0.Final&lt;/version&gt;&#x000A;             &lt;type&gt;pom&lt;/type&gt;&#x000A;             &lt;scope&gt;provided&lt;/scope&gt;&#x000A;             &lt;exclusions&gt;&#x000A;                 &lt;exclusion&gt;&#x000A;                     &lt;groupId&gt;xalan&lt;/groupId&gt;&#x000A;                     &lt;artifactId&gt;xalan&lt;/artifactId&gt;&#x000A;                 &lt;/exclusion&gt;&#x000A;             &lt;/exclusions&gt;&#x000A;         &lt;/dependency&gt;&#x000A;    &lt;/dependencies&gt;&#x000A;    &lt;build&gt;&#x000A;        &lt;testResources&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;            &lt;testResource&gt;&#x000A;                &lt;directory&gt;src/test/resources-jbossas-managed&lt;/directory&gt;&#x000A;            &lt;/testResource&gt;&#x000A;        &lt;/testResources&gt;&#x000A;    &lt;/build&gt;&#x000A;&lt;/profile&gt;&#x000A;&lt;!-- clip --&gt;</code></pre>
<p>We can now run the test again using Maven, this time activating the JBoss AS managed profile:</p>
<pre class="command"><code class="command">$ mvn clean test -Parquillian-jbossas-managed</code></pre>
<p class="warning"><span>Make sure your JBOSS_HOME environment variable points to a JBoss AS 7.1.1.Final installation. Alternatively, you can set the location using the jbossHome property in arquillian.xml.</span></p>
<p>Here&#8217;s the kicker. You can also run this test into your IDE! Just import the project, activate the arquillian-jbossas-managed Maven profile (and deactivate the arquillian-glassfish-embedded profile), open the test case and, finally, select &#8220;Run As &gt; JUnit Test&#8221;. Voila! It works just like any other JUnit test. <strong class="greenbar">Green bar</strong>!</p>
<p><strong>Enjoy the perfect recipe for testing JPA!</strong></p>
<p class="info"><span>While there was a lot of setup in this guide, recognize it&#8217;s because that we left no stone unturned. To remind you of the benefits of Arquillian, just look back at how simple the test case is. Then remind yourself that it&#8217;s not bound to any Java EE 6 container or JPA 2 implementation.</span></p>
  <h3 id="share">Share the Knowledge</h3>
  <p>Find this guide useful?</p>
  <p class="post_to_twitter"><a href="http://twitter.com/home/?status=Just%20read%20the%20%23Arquillian%20Testing%20Java%20Persistence%20guide%20and%20got%20a%20%23greenbar!%20Get%20yours.%20http://arquillian.org/guides/testing_java_persistence/"><img src="/images/post_to_twitter.png" alt="" /></a></p>
  <div class="g-plusone" data-size="tall"></div>
  <p>There&#8217;s a lot more about Arquillian to cover. If you&#8217;re ready to learn more, check out the <a href="/guides">other available guides</a>.</p>
  <h4>Feedback</h4>
  <p>Find a bug in the guide? Something missing? You can fix it by <a href="http://github.com/arquillian/arquillian.github.com">forking this website</a>, making the correction and <a href="http://help.github.com/send-pull-requests">sending a pull request</a>. If you&#8217;re just plain stuck, feel free to ask a question in the <a href="http://community.jboss.org/en/arquillian?view=discussions">user discussion forum</a>.</p>
  <h4>Recent Changelog</h4>
  <ul>
    <li>
      May 08, 2012:
      Update the url of the example project
      <em>by Dan Allen</em>
    </li>
    <li>
      May 07, 2012:
      Instructions for adding a datasource dynamically on jboss as 7.1
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 30, 2012:
      Reference get started faster with forge guide in intro
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 29, 2012:
      Set version on surefire plugin
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 29, 2012:
      Code refinements; clarify statement about weaving
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 29, 2012:
      Add logging configuration; add note about eclipselink weaving; fix console output for test
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 22, 2012:
      Fixed paths to test-persistence.xml for managed jboss as
      <em>by Michael Bruns</em>
    </li>
    <li>
      Apr 21, 2012:
      Fix callouts, change inline command to a block
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 21, 2012:
      Add note about weld profile
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 20, 2012:
      Issue #99 - fix location of beans.xml
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 20, 2012:
      Major update to persistence guide. revise content. include ide instructions
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 16, 2012:
      Some rewording &amp; clarification; add alexis as author
      <em>by Dan Allen</em>
    </li>
    <li>
      Apr 11, 2012:
      Upgrade persistence guide to arquillian 1.0.0.final
      <em>by Alexis Hassler</em>
    </li>
    <li>
      Apr 10, 2012:
      Upgrade persistence guide to jboss as 7.1
      <em>by Alexis Hassler</em>
    </li>
    <li>
      Apr 09, 2012:
      Fixed little typos in persistence guide
      <em>by Alexis Hassler</em>
    </li>
  </ul>
  <p>
    <a href="https://github.com/arquillian/arquillian.github.com/commits/develop/guides/testing_java_persistence.textile">See full history &raquo;</a>
  </p>
</div>
<div id="sidebar">
  <div id="toc">
    <h3 class="chapter_header">Chapters</h3>
    <ol class="chapters">
      <li>
        <a href="#assumptions" id="assumptions_link">Assumptions</a>
      </li>
      <li>
        <a href="#purpose" id="purpose_link">Purpose</a>
      </li>
      <li>
        <a href="#project_structure" id="project_structure_link">Project Structure</a>
      </li>
      <li>
        <a href="#write_the_test" id="write_the_test_link">Write the Test</a>
      </li>
      <li>
        <a href="#setup_persistence_for_glassfish" id="setup_persistence_for_glassfish_link">Setup Persistence for GlassFish</a>
      </li>
      <li>
        <a href="#prep_the_test_for_glassfish" id="prep_the_test_for_glassfish_link">Prep the Test for GlassFish</a>
      </li>
      <li>
        <a href="#run_the_test_on_glassfish" id="run_the_test_on_glassfish_link">Run the Test on GlassFish</a>
      </li>
      <li>
        <a href="#run_the_test_on_jboss_as_7" id="run_the_test_on_jboss_as_7_link">Run the Test on JBoss AS 7</a>
      </li>
      <li>
        <a href="#share" id="share_link">Share the Knowledge</a>
      </li>
    </ol>
  </div>
</div>
<script>
  $(window).load(function() { activateScrollingToc(['assumptions', 'purpose', 'project_structure', 'write_the_test', 'setup_persistence_for_glassfish', 'prep_the_test_for_glassfish', 'run_the_test_on_glassfish', 'run_the_test_on_jboss_as_7', 'share']) })
</script>
  </div>
</div>
    <footer>
      <div class="container">
        <div class="project">
          <img src="/images/arquillian_logo_200px.png" />
          <p class="bottom">
            &#169;
            Copyright 2009-2012 Red Hat, Inc.
            <br />
            <i class="icon-fire"></i>
            Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>. Baked by <a href="http://awestruct.org">Awestruct</a>.
            <br />
            <i class="icon-share-alt"></i>
            Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
            <br />
            Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>.
          </p>
        </div>
        <div class="footer-nav">
          <h4>Learn</h4>
          <ul>
            <li>
              <a href="/invasion">Mission</a>
            </li>
            <li>
              <a href="/features">Features</a>
            </li>
            <li>
              <a href="/guides">Guides</a>
            </li>
            <li>
              <a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Manual</a>
            </li>
            <li>
              <a href="http://community.jboss.org/en/arquillian/faq">FAQs</a>
            </li>
          </ul>
        </div>
        <div class="footer-nav">
          <h4>Get Involved</h4>
          <ul>
            <li>
              <a href="http://community.jboss.org/en/arquillian?view=discussions">Forums</a>
            </li>
            <li>
              <a href="https://issues.jboss.org/browse/ARQ">Issue Tracker</a>
            </li>
            <li>
              <a href="https://github.com/arquillian">Source Code</a>
            </li>
            <li>
              <a href="/community/contributors">Contributors</a>
            </li>
            <li>
              <a href="https://community.jboss.org/groups/testing">Testing SIG</a>
            </li>
          </ul>
        </div>
        <div class="sponser">
          <div class="follow-us">
            <h4>Stay Informed</h4>
            <ul>
              <li>
                <a href="https://plus.google.com/100660127586085393031"><img alt="Google+" src="/images/social/googleplus-16.png" title="Follow Arquillian on Google+" /></a>
              </li>
              <li>
                <a href="https://twitter.com/#!/search/%23arquillian"><img alt="Twitter" src="/images/social/twitter-16.png" title="Browse the #arquillian hashtag on Twitter" /></a>
              </li>
              <li>
                <a href="http://www.linkedin.com/groups?gid=3120340"><img alt="LinkedIn" src="/images/social/linkedin-16.png" title="Join the Arquillian group on LinkedIn" /></a>
              </li>
              <li>
                <a href="http://vimeo.com/channels/arquillian"><img alt="Vimeo" src="/images/social/vimeo-16.png" title="Follow the Arquillian channel on Vimeo" /></a>
              </li>
            </ul>
          </div>
          <p>This website is open source! You can also <a href="http://www.seethestats.com/site/arquillian.org">see the stats</a>. If you want to help, <a href="http://github.com/arquillian/arquillian.github.com">fork the project</a> and hack on it.</p>
          <p class="image"><a href="http://jboss.org"><img src="/images/jboss_redhat_branding.png" class="branding" title="Red Hat, Inc." alt="Red Hat, Inc." /></a></p>
          <p>Arquillian is a <a href="http://jboss.org">JBoss Community</a> project and development is sponsored by Red Hat, Inc.</p>
          <p class="bottom"><a href="http://www.redhat.com/legal/legal_statement.html">Terms of Use</a> | <a href="http://www.redhat.com/legal/privacy_statement.html">Privacy Policy</a></p>
        </div>
        <a class="visible-desktop" href="#" id="toTop">Top</a>
      </div>
    </footer>
    <script>
      $(function() {
        $('html').addClass('ready');
        prettify();
        activateFooterGravity();
        activateTooltips();
        activateToTopControl();
      });
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.0.2/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>
    <script src="/javascripts/site.js"></script>
    <script src="/javascripts/jquery-scroll.js"></script>
    <script src="http://apis.google.com/js/plusone.js"></script>
  </body>
</html>
